name: Enforce GitFlow on Pull Requests

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  enforce-gitflow:
    name: Validate GitFlow Rules
    runs-on: ubuntu-latest

    steps:
      - name: Get source and target branches
        id: context
        run: |
          SRC="${{ github.head_ref }}"
          DEST="${{ github.base_ref }}"
          echo "üîç Pull Request from '$SRC' ‚Üí '$DEST'"
          echo "src=$SRC" >> $GITHUB_OUTPUT
          echo "dest=$DEST" >> $GITHUB_OUTPUT

      - name: Validate GitFlow rules
        run: |
          SRC="${{ steps.context.outputs.src }}"
          DEST="${{ steps.context.outputs.dest }}"

          echo "üß© Validating PR flow: $SRC ‚Üí $DEST"

          # Feature ‚Üí develop
          if [[ "$SRC" =~ ^feature- ]] && [ "$DEST" != "develop" ]; then
            echo "‚ùå Invalid PR: Features can only be merged into 'develop'."
            exit 1
          fi

          # Bugfix ‚Üí develop
          if [[ "$SRC" =~ ^bugfix- ]] && [ "$DEST" != "develop" ]; then
            echo "‚ùå Invalid PR: Bugfixes can only be merged into 'develop'."
            exit 1
          fi

          # Release ‚Üí main
          if [[ "$SRC" =~ ^release- ]] && [ "$DEST" != "main" ]; then
            echo "‚ùå Invalid PR: Releases can only be merged into 'main'."
            exit 1
          fi

          # Hotfix ‚Üí main
          if [[ "$SRC" =~ ^hotfix- ]] && [ "$DEST" != "main" ]; then
            echo "‚ùå Invalid PR: Hotfixes can only be merged into 'main'."
            exit 1
          fi

          # develop ‚Üí main (permitido, para promoci√≥n)
          if [ "$SRC" = "develop" ] && [ "$DEST" != "main" ]; then
            echo "‚ùå Invalid PR: 'develop' can only be merged into 'main'."
            exit 1
          fi

          echo "‚úÖ Valid GitFlow PR: $SRC ‚Üí $DEST"