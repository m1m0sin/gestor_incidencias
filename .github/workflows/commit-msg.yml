- name: Validate commit messages
  shell: bash
  run: |
    echo "üîç Validating commit messages..."

    BEFORE_SHA="${{ github.event.before }}"
    AFTER_SHA="${{ github.sha }}"
    EVENT_NAME="${{ github.event_name }}"
    BASE_REF="${{ github.base_ref }}"   # rama base del PR (por ejemplo 'develop' o 'main')

    git fetch origin +refs/heads/*:refs/remotes/origin/*

    if [ "$EVENT_NAME" = "push" ]; then
      if [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
        commits=$(git log -1 --pretty=format:"%s")
      else
        commits=$(git log "$BEFORE_SHA".."$AFTER_SHA" --pretty=format:"%s")
      fi
    else
      commits=$(git log "origin/$BASE_REF"..HEAD --pretty=format:"%s")
    fi

    if [ -z "$commits" ]; then
      echo "‚ö†Ô∏è No commits found to validate."
      exit 0
    fi

    echo "$commits" | while read -r message; do
      # üü° Ignorar merges autom√°ticos de GitHub
      if [[ "$message" =~ ^Merge ]]; then
        echo "‚ö†Ô∏è Skipping merge commit: \"$message\""
        continue
      fi

      if ! echo "$message" | grep -Pq '^(?:(?:((?:AB#[0-9]{1,6}(?:,\s?AB#[0-9]{1,6}\s?)*))-\s?)?(feat|fix|style|build|ci|refactor|test|doc|revert)(\([^)]{0,10}\))?:\s?.{5,60})$'; then
        echo "‚ùå Commit message invalid: \"$message\""
        exit 1
      else
        echo "‚úÖ Valid: \"$message\""
      fi
    done

    echo "üéâ All commit messages are valid!"
